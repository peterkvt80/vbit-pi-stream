#!/bin/sh

# getteletext creates several script files required by VBIT.
# If you run this more than once you may lose pages or configuration.
# Instead use updatesystem to load the latest VBIT/raspi-teletext 
cd ~

echo "Installing version control packages"
# install version control packages for VBIT
sudo apt-get update
sudo apt-get -y install git subversion

echo "Installing vbit-pi-stream"
#install vbit-pi-stream
git clone https://github.com/peterkvt80/vbit-pi-stream.git ~/vbit
cd ~/vbit
make

echo "Installing raspi-teletext"
#install raspi-teletext
git clone https://github.com/ali1234/raspi-teletext/ ~/raspi-teletext-master/
cd ~/raspi-teletext-master/
make clean
make

echo "Installing teletext pages"
mkdir ~/Pages
mkdir ~/teletext
cd ~/Pages
rm -f pages.zip
wget -O pages.zip https://www.dropbox.com/sh/ue14zczs71zemuh/AAC_8OPbgZQCLb9HT4XwtEC7a?dl=1
unzip -o pages.zip

#teefax pages
svn checkout http://teastop.plus.com/svn/teletext/ ~/teletext

# install default config files
cp ~/vbit/example-vbit.conf ~/Pages/vbit.conf
cp ~/vbit/example-vbit.conf ~/teletext/vbit.conf

cd ~/vbit
chmod +x updatesystem
chmod +x updatepages

# System sets SD video on bootup 
sudo sed -i s/#sdtv_mode/sdtv_mode/ /boot/config.txt

echo "Installing scripts"
#install scripts
cd ~

cat > ~/go << EOF
#!/bin/bash
# "go" Autogenerated by getteletext
# This runs the VBIT teletext system

# to change the directory where vbit and raspi-teletext, edit the line below 
export HOME=/home/pi

# to change the directory in which vbit looks for pages edit the line below
PAGESDIRECTORY=\$HOME/teletext

PID=\$\$

function exitgo {
  kill \`ps -o pid --no-headers --ppid \$PID\` >/dev/null 2>&1
  rm /var/tmp/vbit-go.pid
}

# create a pid file
if [ -f /var/tmp/vbit-go.pid ]; then
  OLDPID=\`cat /var/tmp/vbit-go.pid\`
  RESULT=\`ps -ef | grep \$OLDPID | grep "go"\`

  if [ -n "\${RESULT}" ]; then
    echo "Script already running"
    exit 255
  fi
fi

echo \$PID > /var/tmp/vbit-go.pid

trap exitgo EXIT

sudo ~/raspi-teletext-master/tvctl on

# This loop restarts the teletext server if it stops.
# To stop teletext you should kill this process and not vbit or raspi.
until \$HOME/vbit/vbit --dir \$PAGESDIRECTORY | \$HOME/raspi-teletext-master/teletext -; do
    trap 'exit' INT HUP TERM
    echo "VBIT Server crashed with exit code 0.  Respawning.." >&2
    sleep 1
done
EOF
chmod +x go

cat > ~/vbit.sh << EOF
#!/bin/sh

# /etc/init.d/vbit.sh
# "vbit.sh" Autogenerated by getteletext
# Startup script to go in /etc/init.d

# Some things that run always
#

# Carry out specific functions when asked to by the system
case "\$1" in
  start)
    cd /home/pi
    ./go &
    echo "Starting script vbit"
    echo "Could do more here"
    ;;
  stop)
    if [ -f /var/tmp/vbit-go.pid ]; then
      PID=\`cat /var/tmp/vbit-go.pid\`
      RESULT=\`ps -ef | grep \$PID | grep "go"\`

      if [ "\${RESULT}" ]; then
        kill \$PID
      fi
    fi

    echo "Stopping script vbit"
    echo "Could do more here"
    ;;
  *)
    echo "Usage: /etc/init.d/vbit {start|stop}"
    exit 1
    ;;
esac

exit 0
EOF
chmod +x vbit.sh

cat > ~/updatePages.sh << EOF
#!/bin/sh

# "updatePages.sh" Autogenerated by getteletext
# Script to fetch text pages
# As this is run by root, you will need to change /home/pi below to your own home directory.
# I expect there is a system export that could take care of this problem automatically

svn update /home/pi/teletext
EOF
chmod +x updatePages.sh

