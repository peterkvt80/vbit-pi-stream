#!/bin/sh

# getteletext creates several script files required by VBIT.
# If you run this more than once you may lose pages or configuration.
# Instead use updatesystem to load the latest VBIT/raspi-teletext 
cd /home/pi

echo "Installing version control packages"
# install version control packages for VBIT
sudo apt-get update
sudo apt-get -y install git subversion

echo "Installing vbit-pi-stream"
#install vbit-pi-stream
git clone https://github.com/peterkvt80/vbit-pi-stream.git /home/pi/vbit
cd /home/pi/vbit
make

echo "Installing raspi-teletext"
#install raspi-teletext
git clone https://github.com/ali1234/raspi-teletext/ /home/pi/raspi-teletext-master/
cd /home/pi/raspi-teletext-master/
make clean
make

echo "Installing teletext pages"
# install the pages from scripts that vbit loaded in
cd /home/pi/vbit
chmod +x updatesystem
chmod +x updatepages
./updatepages

echo "Installing scripts"
#install scripts
cd /home/pi

cat > /home/pi/go << EOF
#!/bin/sh

# "go" Autogenerated by getteletext
# This runs the VBIT teletext system
sudo /home/pi/raspi-teletext-master/tvctl on

# This loop restarts the teletext server if it stops.
# To stop teletext you should kill this process and not vbit or raspi.
until /home/pi/vbit/vbit | /home/pi/raspi-teletext-master/teletext -; do
    echo "VBIT Server crashed with exit code $?.  Respawning.." >&2
    sleep 1
done
EOF
chmod +x go

cat > /home/pi/vbit.sh << EOF
#!/bin/sh
# /etc/init.d/vbit.sh
# "vbit.sh" Autogenerated by getteletext
# Startup script to go in /etc/init.d

# Some things that run always
#

# Carry out specific functions when asked to by the system
case "$1" in
  start)
    cd /home/pi
    ./go &
    echo "Starting script vbit"
    echo "Could do more here"
    ;;
  stop)
    echo "Stopping script vbit"
    echo "Could do more here"
    ;;
  *)
    echo "Usage: /etc/init.d/vbit {start|stop}"
    exit 1
    ;;
esac

exit 0
EOF
chmod +x vbit.sh

